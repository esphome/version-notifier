name: Update ESPHome Version in Firmware Repos

on:
  workflow_dispatch:
    inputs:
      version:
        description: "ESPHome version to update to (e.g., 2024.1.0)"
        required: true
        type: string
  workflow_run:
    workflows: ["Notify"]
    types:
      - completed

jobs:
  prepare:
    name: Prepare Matrix
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    outputs:
      matrix: ${{ steps.matrix.outputs.repos }}
      version: ${{ steps.version.outputs.esphome_version }}
      is_stable: ${{ steps.version.outputs.is_stable }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download version artifact
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: esphome-version
          github-token: ${{ github.token }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Get ESPHome version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(cat esphome_version.txt)
          fi
          echo "esphome_version=${VERSION}" >> $GITHUB_OUTPUT

          # Check if version is stable (not beta or dev)
          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "is_stable=true" >> $GITHUB_OUTPUT
          else
            echo "Skipping non-stable version: $VERSION"
            echo "is_stable=false" >> $GITHUB_OUTPUT
          fi

      - name: Load configuration
        id: matrix
        run: |
          REPOS=$(jq -c '.' repos.json)
          echo "repos=${REPOS}" >> $GITHUB_OUTPUT

  update-repo:
    name: Update ${{ matrix.repo }}
    needs: prepare
    if: needs.prepare.outputs.is_stable == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Generate token
        id: generate-token
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        with:
          app-id: ${{ secrets.ESPHOME_GITHUB_APP_ID }}
          private-key: ${{ secrets.ESPHOME_GITHUB_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ matrix.repo }}

      - name: Checkout target repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ github.repository_owner }}/${{ matrix.repo }}
          token: ${{ steps.generate-token.outputs.token }}
          path: target-repo

      - name: Update ESPHome version in workflows
        id: update
        working-directory: target-repo
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          UPDATED=false
          CURRENT_VERSION="unknown"

          # Parse workflow_files JSON array
          WORKFLOW_FILES='${{ toJson(matrix.workflow_files) }}'

          for FILE in $(echo "$WORKFLOW_FILES" | jq -r '.[]'); do
            WORKFLOW_FILE=".github/workflows/$FILE"

            if [ ! -f "$WORKFLOW_FILE" ]; then
              echo "::warning::Workflow file not found: $WORKFLOW_FILE"
              continue
            fi

            # Extract current version for comparison
            FILE_VERSION=$(grep -oP 'esphome-version:\s*["\x27]?\K[0-9]+\.[0-9]+\.[0-9]+' "$WORKFLOW_FILE" | head -1 || echo "unknown")
            echo "File: $FILE - Current version: $FILE_VERSION, Target version: $VERSION"

            if [ "$FILE_VERSION" = "$VERSION" ]; then
              echo "  Already up to date"
              continue
            fi

            # Track the original version for PR description
            if [ "$CURRENT_VERSION" = "unknown" ]; then
              CURRENT_VERSION="$FILE_VERSION"
            fi

            # Update the esphome-version in the workflow file
            # Handles both quoted and unquoted versions
            sed -i -E "s/(esphome-version:\s*[\"']?)[0-9]+\.[0-9]+\.[0-9]+([\"']?)/\1${VERSION}\2/g" "$WORKFLOW_FILE"
            UPDATED=true
          done

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: create-pr
        if: steps.update.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@84ae59a2cdc2258d6fa0732dd66352dddae2a412 # v7.0.9
        with:
          token: ${{ steps.generate-token.outputs.token }}
          path: target-repo
          branch: esphome-version-update
          delete-branch: true
          title: "Update ESPHome to ${{ needs.prepare.outputs.version }}"
          body: |
            This PR updates ESPHome from `${{ steps.update.outputs.current_version }}` to `${{ needs.prepare.outputs.version }}`.

            ---
            *This is an automated PR created by the ESPHome [version-notifier](https://github.com/${{ github.repository }}).*
          commit-message: "Update ESPHome to ${{ needs.prepare.outputs.version }}"
          committer: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          labels: |
            dependencies
            esphome

      - name: Add PR to summary
        if: steps.create-pr.outputs.pull-request-url
        run: |
          echo "### ${{ matrix.repo }}" >> $GITHUB_STEP_SUMMARY
          echo "- PR: ${{ steps.create-pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY

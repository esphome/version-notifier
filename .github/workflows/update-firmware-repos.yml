name: Update ESPHome Version in Firmware Repos

on:
  workflow_dispatch:
    inputs:
      esphome_version:
        description: "ESPHome version to update to (e.g., 2024.1.0)"
        required: true
        type: string
  workflow_run:
    workflows: ["Notify"]
    types:
      - completed

jobs:
  prepare:
    name: Prepare Matrix
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    outputs:
      matrix: ${{ steps.matrix.outputs.repos }}
      version: ${{ steps.version.outputs.esphome_version }}
      is_stable: ${{ steps.version.outputs.is_stable }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download version artifact
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: esphome-version
          github-token: ${{ github.token }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Get ESPHome version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.esphome_version }}"
          else
            VERSION=$(cat esphome_version.txt)
          fi
          echo "esphome_version=${VERSION}" >> $GITHUB_OUTPUT

          # Check if version is stable (not beta or dev)
          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "is_stable=true" >> $GITHUB_OUTPUT
          else
            echo "Skipping non-stable version: $VERSION"
            echo "is_stable=false" >> $GITHUB_OUTPUT
          fi

      - name: Load configuration
        id: matrix
        run: |
          REPOS=$(jq -c '.' repos.json)
          echo "repos=${REPOS}" >> $GITHUB_OUTPUT

  update-repo:
    name: Update ${{ matrix.repo }}
    needs: prepare
    if: needs.prepare.outputs.is_stable == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Generate token
        id: generate-token
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        with:
          app-id: ${{ secrets.ESPHOME_GITHUB_APP_ID }}
          private-key: ${{ secrets.ESPHOME_GITHUB_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ matrix.repo_name }}

      - name: Checkout target repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ matrix.repo }}
          token: ${{ steps.generate-token.outputs.token }}
          path: target-repo

      - name: Update ESPHome version in workflow
        id: update
        working-directory: target-repo
        run: |
          WORKFLOW_FILE=".github/workflows/${{ matrix.workflow_file }}"
          VERSION="${{ needs.prepare.outputs.version }}"

          if [ ! -f "$WORKFLOW_FILE" ]; then
            echo "::error::Workflow file not found: $WORKFLOW_FILE"
            exit 1
          fi

          # Extract current version for comparison
          CURRENT_VERSION=$(grep -oP 'esphome-version:\s*["\x27]?\K[0-9]+\.[0-9]+\.[0-9]+' "$WORKFLOW_FILE" | head -1 || echo "unknown")
          echo "Current version: $CURRENT_VERSION"
          echo "Target version: $VERSION"

          if [ "$CURRENT_VERSION" = "$VERSION" ]; then
            echo "Version already up to date"
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Update the esphome-version in the workflow file
          # Handles both quoted and unquoted versions
          sed -i -E "s/(esphome-version:\s*[\"']?)[0-9]+\.[0-9]+\.[0-9]+([\"']?)/\1${VERSION}\2/g" "$WORKFLOW_FILE"

          echo "updated=true" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.update.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@84ae59a2cdc2258d6fa0732dd66352dddae2a412 # v7.0.9
        with:
          token: ${{ steps.generate-token.outputs.token }}
          path: target-repo
          branch: esphome-version-update
          delete-branch: true
          title: "Update ESPHome to ${{ needs.prepare.outputs.version }}"
          body: |
            This PR updates ESPHome from `${{ steps.update.outputs.current_version }}` to `${{ needs.prepare.outputs.version }}`.

            ---
            *This is an automated PR created by the ESPHome [version-notifier](https://github.com/${{ github.repository }}).*
          commit-message: "Update ESPHome to ${{ needs.prepare.outputs.version }}"
          committer: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          labels: |
            dependencies
            esphome
